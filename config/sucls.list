/**
 * Sub-Store rename.jsï¼ˆç»ˆæžç»Ÿä¸€ç‰ˆ / é•¿æœŸä½¿ç”¨ï¼‰
 *
 * âœ… å…¨èŠ‚ç‚¹ç»Ÿä¸€æ ¼å¼ï¼š
 *    ðŸ‡¸ðŸ‡¬æ–°åŠ å¡02-0.1å€ | é«˜é€Ÿä¸“çº¿-hy2
 *
 * âœ… å›½æ——æ¥æºï¼š
 *    1) åŽŸåè‡ªå¸¦å›½æ—— -> ç›´æŽ¥ç”¨ï¼ˆè‡ªåŠ¨æ”¯æŒæœªæ¥æ–°å›½å®¶ï¼‰
 *    2) æ²¡å›½æ——ä½†èƒ½è¯†åˆ«å›½å®¶ -> è‡ªåŠ¨ç”Ÿæˆå›½æ——
 *    3) å®žåœ¨è¯†åˆ«ä¸äº† -> ðŸ³ï¸æœªçŸ¥
 *
 * âœ… åºå·ï¼š
 *    - ä¼˜å…ˆå–â€œæœ«å°¾ 01/02/03...â€ï¼Œä¸å…¨å±€é‡æŽ’
 *    - é¿å…æŠŠ AWS01 è¿™ç§å½“æˆåºå·
 *
 * âœ… å€çŽ‡ï¼š
 *    - 0.1å€ / 2å€ / 2x / x2 / 2Ã— / Ë£Â² / Ë£Â¹â° ... è‡ªåŠ¨æŠ“
 *
 * âœ… æè¿°ï¼š
 *    - ä¿ç•™åŽŸåé™¤â€œå›½å®¶/å›½æ——/åºå·/å€çŽ‡â€ä¹‹å¤–çš„å†…å®¹
 *    - è‡ªåŠ¨æ¸…ç† hy2#3 / AWS#2 è¿™ç§å°¾å·´ï¼Œä¿è¯ç»Ÿä¸€
 *
 * Sub-Store çŽ¯å¢ƒï¼šåªç”¨ $arguments + operator(proxies)
 */

const inArg = typeof $arguments !== "undefined" ? $arguments : {};

// ===== é»˜è®¤å…¨å¼€ï¼šä½ ç›´æŽ¥ç”¨å°±è¡Œ =====
const nm = inArg.nm !== undefined ? !!inArg.nm : true;           // æœªè¯†åˆ«å›½å®¶ä¹Ÿä¿ç•™ï¼ˆå¹¶ç»Ÿä¸€æˆ ðŸ³ï¸æœªçŸ¥ï¼‰
const addflag = inArg.flag !== undefined ? !!inArg.flag : true;  // è‡ªåŠ¨åŠ å›½æ——ï¼ˆä¼˜å…ˆç”¨åŽŸåè‡ªå¸¦ï¼‰
const SEP = typeof inArg.sep === "string" ? decodeURI(inArg.sep) : " | ";
const FNAME = inArg.name ? decodeURI(inArg.name) : "";           // å¯é€‰å‰ç¼€
const nf = !!inArg.nf;                                           // å‰ç¼€æ”¾å‰ï¼ˆä¿ç•™å‚æ•°ä½ï¼‰

// ===== ISO2 -> ä¸­æ–‡åï¼ˆå¸¸ç”¨ + æµåª’ä½“/æœºåœºå¸¸è§ï¼‰=====
const ISO2_ZH = {
  HK: "é¦™æ¸¯", MO: "æ¾³é—¨", TW: "å°æ¹¾", JP: "æ—¥æœ¬", KR: "éŸ©å›½", SG: "æ–°åŠ å¡", US: "ç¾Žå›½",
  GB: "è‹±å›½", UK: "è‹±å›½", DE: "å¾·å›½", FR: "æ³•å›½", IT: "æ„å¤§åˆ©", ES: "è¥¿ç­ç‰™", NL: "è·å…°",
  CH: "ç‘žå£«", SE: "ç‘žå…¸", NO: "æŒªå¨", DK: "ä¸¹éº¦", FI: "èŠ¬å…°", IE: "çˆ±å°”å…°", PT: "è‘¡è„ç‰™",
  AT: "å¥¥åœ°åˆ©", BE: "æ¯”åˆ©æ—¶", PL: "æ³¢å…°", CZ: "æ·å…‹", HU: "åŒˆç‰™åˆ©", GR: "å¸Œè…Š",
  RO: "ç½—é©¬å°¼äºš", BG: "ä¿åŠ åˆ©äºš", RU: "ä¿„ç½—æ–¯", UA: "ä¹Œå…‹å…°",
  TR: "åœŸè€³å…¶", AE: "é˜¿è”é…‹", SA: "æ²™ç‰¹", IL: "ä»¥è‰²åˆ—", QA: "å¡å¡”å°”",
  IN: "å°åº¦", ID: "å°å°¼", VN: "è¶Šå—", TH: "æ³°å›½", MY: "é©¬æ¥è¥¿äºš", PH: "è²å¾‹å®¾",
  AU: "æ¾³å¤§åˆ©äºš", NZ: "æ–°è¥¿å…°", CA: "åŠ æ‹¿å¤§",
};

// ===== è‹±æ–‡å›½å®¶å -> ISO2ï¼ˆç”¨æ¥è¯†åˆ« United States / Japan è¿™ç§ï¼‰=====
const ENNAME_ISO2 = [
  [/hong\s*kong/i, "HK"],
  [/macao|macau/i, "MO"],
  [/taiwan/i, "TW"],
  [/japan/i, "JP"],
  [/korea|south\s*korea/i, "KR"],
  [/singapore/i, "SG"],
  [/united\s*states|usa\b/i, "US"],
  [/united\s*kingdom|great\s*britain|england|uk\b/i, "GB"],
  [/germany/i, "DE"],
  [/france/i, "FR"],
  [/australia/i, "AU"],
  [/new\s*zealand/i, "NZ"],
  [/canada/i, "CA"],
  [/turkey/i, "TR"],
  [/united\s*arab\s*emirates|uae\b|dubai/i, "AE"],
  [/india/i, "IN"],
];

// ===== ä¸­æ–‡å…³é”®è¯ -> ISO2ï¼ˆå…œåº•è¯†åˆ«ï¼‰=====
const CNNAME_ISO2 = [
  [/é¦™æ¸¯/, "HK"], [/æ¾³é—¨/, "MO"], [/å°æ¹¾|å°åŒ—|æ–°åŒ—|é«˜é›„|å°ä¸­/, "TW"],
  [/æ—¥æœ¬|ä¸œäº¬|å¤§é˜ª|åå¤å±‹|æœ­å¹Œ|ç¦å†ˆ/, "JP"],
  [/éŸ©å›½|é¦–å°”|é‡œå±±|ä»å·|æ˜¥å·/, "KR"],
  [/æ–°åŠ å¡|ç‹®åŸŽ/, "SG"],
  [/ç¾Žå›½|æ´›æ‰çŸ¶|åœ£ä½•å¡ž|çº½çº¦|è¥¿é›…å›¾|èŠåŠ å“¥|ç¡…è°·|æ³¢ç‰¹å…°/, "US"],
  [/è‹±å›½|ä¼¦æ•¦/, "GB"],
  [/å¾·å›½|æ³•å…°å…‹ç¦/, "DE"],
  [/æ³•å›½|å·´é»Ž/, "FR"],
  [/æ¾³å¤§åˆ©äºš|æ‚‰å°¼|å¢¨å°”æœ¬/, "AU"],
  [/åœŸè€³å…¶|ä¼Šæ–¯å¦å¸ƒå°”/, "TR"],
  [/é˜¿è”é…‹|è¿ªæ‹œ|é˜¿å¸ƒæ‰Žæ¯”/, "AE"],
  [/å°åº¦|å­Ÿä¹°|å¾·é‡Œ/, "IN"],
];

// ===== å·¥å…·ï¼šæ¸…ç†ç©ºç™½/åˆ†éš”ç¬¦ =====
function tidy(s) {
  return (s || "")
    .replace(/\s+/g, " ")
    .replace(/\s*\|\s*/g, " | ")
    .replace(/\s*-\s*/g, "-")
    .trim();
}

// ===== åŽ»æŽ‰åŽŸåå›½æ——ï¼Œé¿å…å åŠ  =====
function stripFlags(s) {
  return (s || "").replace(/[\u{1F1E6}-\u{1F1FF}]{2}/gu, "").trim();
}

// ===== å›½æ—— emoji -> ISO2 =====
function flagToISO2(flag) {
  const cps = [...flag].map((ch) => ch.codePointAt(0));
  if (cps.length !== 2) return "";
  const A = 0x1f1e6;
  const c1 = cps[0] - A;
  const c2 = cps[1] - A;
  if (c1 < 0 || c1 > 25 || c2 < 0 || c2 > 25) return "";
  return String.fromCharCode(65 + c1) + String.fromCharCode(65 + c2);
}

// ===== ISO2 -> å›½æ—— =====
function iso2ToFlag(iso2) {
  if (!/^[A-Z]{2}$/.test(iso2)) return "";
  const A = 0x1f1e6;
  const c1 = iso2.charCodeAt(0) - 65;
  const c2 = iso2.charCodeAt(1) - 65;
  if (c1 < 0 || c1 > 25 || c2 < 0 || c2 > 25) return "";
  return String.fromCodePoint(A + c1) + String.fromCodePoint(A + c2);
}

// ===== å€çŽ‡æŠ“å–ï¼š0.1å€ / 2å€ / 2x / x2 / 2Ã— / Ë£Â² ... =====
function pickRatio(name) {
  const n = name || "";

  // Ë£Â²/Ë£Â³/Ë£Â¹â°...
  const sup = n.match(/Ë£(?:[Â²Â³â´âµâ¶â·â¸â¹]|Â¹â°|Â²â°|Â³â°|â´â°|âµâ°)/);
  if (sup) return sup[0];

  // 0.1å€ / 2å€
  const m1 = n.match(/(\d+(?:\.\d+)?)\s*å€/);
  if (m1) return `${m1[1]}å€`;

  // 2x / 2X / 2Ã—
  const m2 = n.match(/(\d+(?:\.\d+)?)\s*(?:x|X|Ã—)/);
  if (m2) return `${m2[1]}Ã—`;

  // x2 / Ã—2
  const m3 = n.match(/(?:x|X|Ã—)\s*(\d+(?:\.\d+)?)/);
  if (m3) return `${m3[1]}Ã—`;

  return "";
}

// ===== åºå·æŠ“å–ï¼šåªå–æœ«å°¾ 01/02...ï¼Œé¿å… AWS01 è¯¯ä¼¤ =====
function pickIndex(name) {
  const s = name || "";
  // æœ«å°¾ 2 ä½ï¼š... 01
  const m = s.match(/(?:^|[^A-Za-z0-9])(\d{2})\s*$/);
  if (m) return m[1];

  // æœ«å°¾ 1 ä½ï¼š... 3 -> 03
  const m2 = s.match(/(?:^|[^A-Za-z0-9])(\d)\s*$/);
  if (m2) return `0${m2[1]}`;

  return "";
}

// ===== è¯†åˆ«å›½å®¶ï¼šå›½æ—— > ISO2 > è‹±æ–‡å›½å®¶å > ä¸­æ–‡å…³é”®è¯ =====
function detectCountry(rawName) {
  const raw = rawName || "";

  // 1) åŽŸåè‡ªå¸¦å›½æ——ï¼ˆæœ€å¼ºï¼šæœªæ¥æ–°å›½å®¶ä¹Ÿèƒ½ç”¨ï¼‰
  const flagMatch = raw.match(/[\u{1F1E6}-\u{1F1FF}]{2}/u);
  if (flagMatch) {
    const flag = flagMatch[0];
    const iso2 = flagToISO2(flag);
    const zh = ISO2_ZH[iso2] || iso2 || "æœªçŸ¥";
    return { iso2: iso2 || "", zh, flag };
  }

  // 2) ISO2ï¼ˆå°½é‡ä¸¥è°¨ï¼šUS/JP/SG...ï¼‰
  const iso2Match = raw.match(/(^|[^A-Za-z0-9])([A-Za-z]{2})(?=[^A-Za-z0-9]|$)/);
  if (iso2Match) {
    const iso2 = iso2Match[2].toUpperCase();
    if (/^[A-Z]{2}$/.test(iso2)) {
      const zh = ISO2_ZH[iso2] || iso2;
      const flag = iso2ToFlag(iso2);
      return { iso2, zh, flag };
    }
  }

  // 3) è‹±æ–‡å›½å®¶å
  for (const [re, iso2] of ENNAME_ISO2) {
    if (re.test(raw)) {
      const zh = ISO2_ZH[iso2] || iso2;
      const flag = iso2ToFlag(iso2);
      return { iso2, zh, flag };
    }
  }

  // 4) ä¸­æ–‡å…³é”®è¯
  for (const [re, iso2] of CNNAME_ISO2) {
    if (re.test(raw)) {
      const zh = ISO2_ZH[iso2] || iso2;
      const flag = iso2ToFlag(iso2);
      return { iso2, zh, flag };
    }
  }

  return null;
}

// ===== æ¸…ç†æè¿°é‡Œé‚£äº›â€œ#2/#3â€åžƒåœ¾å°¾å·´ï¼Œä¿è¯ç»Ÿä¸€ =====
function cleanWeirdSuffix(desc) {
  let d = desc || "";

  // æŠŠ hy2#3 / AWS#2 è¿™ç§åŽ»æŽ‰ #nï¼ˆä¿ç•™ä¸»ä½“ hy2/AWSï¼‰
  d = d.replace(/([A-Za-z0-9]+)\s*#\s*\d+/g, "$1");

  // æŠŠå­¤ç«‹çš„ #2 ä¹ŸåŽ»æŽ‰
  d = d.replace(/#\s*\d+/g, "");

  return tidy(d);
}

// ===== æž„é€ æœ€ç»ˆåå­— =====
function buildName(oldName) {
  const raw0 = tidy(oldName);
  if (!raw0) return raw0;

  const info = detectCountry(raw0);
  const rawNoFlag = tidy(stripFlags(raw0));

  const idx = pickIndex(rawNoFlag);
  const ratio = pickRatio(rawNoFlag);

  // æè¿°ï¼šä»ŽåŽŸåå‰¥ç¦»å›½å®¶/å›½æ——/åºå·/å€çŽ‡ï¼Œå‰©ä¸‹çš„å°±æ˜¯â€œå³ä¾§æè¿°â€
  let desc = rawNoFlag;

  // åŽ»å€çŽ‡ï¼ˆå‡ºçŽ°è¿‡çš„éƒ½åŽ»ï¼‰
  if (ratio) {
    const esc = ratio.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    desc = desc.replace(new RegExp(esc, "g"), "");
  }

  // åŽ»æœ«å°¾åºå·
  if (idx) {
    desc = desc.replace(new RegExp(`(?:^|\\s|\\||-|_)${idx}\\s*$`), " ");
  }

  // åŽ»å›½å®¶ä¸­æ–‡å/ISO2ï¼ˆå°½é‡è½»åˆ ï¼Œé¿å…è¯¯ä¼¤ AWS01 è¿™ç§ï¼‰
  if (info) {
    if (info.zh && info.zh !== "æœªçŸ¥") {
      const escZh = info.zh.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      desc = desc.replace(new RegExp(escZh, "g"), " ");
    }
    if (info.iso2) {
      const escIso = info.iso2.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      desc = desc.replace(new RegExp(`(^|[^A-Za-z0-9])${escIso}([^A-Za-z0-9]|$)`, "g"), " ");
    }
  }

  // æ¸…ç†ä¸€äº›å¤šä½™åˆ†éš”ç¬¦
  desc = tidy(desc);
  desc = desc.replace(/^\|\s*/g, "").replace(/\s*\|$/g, "");
  desc = cleanWeirdSuffix(desc);

  // å¦‚æžœ desc è¢«åˆ ç©ºäº†ï¼šåšä¸€ä¸ªâ€œç»Ÿä¸€å…œåº•â€
  // - å¦‚æžœåŽŸåé‡Œæœ‰ hy2/tuic/hysteria2 ç­‰ï¼Œå°±ç»™å®ƒä¸€ä¸ªä½ æƒ³è¦çš„ç»Ÿä¸€æ ·å¼
  const protoHint =
    /(\bhy2\b|\bhysteria2\b|\btuic\b|\breality\b|\bxudp\b|\budp\b|\bvless\b|\bvmess\b|\btrojan\b|\bss\b)/i.exec(rawNoFlag);
  if (!desc) {
    if (protoHint && /hy2/i.test(protoHint[0])) desc = "é«˜é€Ÿä¸“çº¿-hy2";
    else if (protoHint) desc = `é«˜é€Ÿä¸“çº¿-${protoHint[0].toLowerCase()}`;
    else desc = "é«˜é€Ÿä¸“çº¿";
  }

  // å·¦ä¾§ï¼šå›½æ—— + å›½å®¶ + åºå· + å€çŽ‡
  const countryZh = info ? info.zh : "æœªçŸ¥";
  const flag = addflag ? (info ? info.flag : "ðŸ³ï¸") : "";
  const left = `${flag}${countryZh}${idx ? idx : ""}${ratio ? `-${ratio}` : ""}`;

  let finalName = `${left}${SEP}${desc}`;

  // å¯é€‰ï¼šåŠ å‰ç¼€ name=
  if (FNAME) {
    finalName = nf ? `${FNAME} ${finalName}` : `${FNAME} ${finalName}`;
  }

  return tidy(finalName);
}

// ===== Clash name å¿…é¡»å”¯ä¸€ï¼šé‡å¤å°±åŠ  Â·2 Â·3ï¼ˆä¸å†å‡ºçŽ° hy2#3 è¿™ç§ä¸‘ä¸œè¥¿ï¼‰=====
function ensureUnique(list) {
  const seen = new Map();
  for (const p of list) {
    const n = p.name;
    const c = seen.get(n) || 0;
    if (c === 0) {
      seen.set(n, 1);
    } else {
      const nn = c + 1;
      seen.set(n, nn);
      p.name = `${n}Â·${nn}`;
    }
  }
  return list;
}

// ===== Sub-Store å…¥å£ =====
function operator(proxies) {
  if (!Array.isArray(proxies)) return proxies;

  for (const p of proxies) {
    if (!p || !p.name) continue;

    const newName = buildName(p.name);
    if (newName === null) {
      p.name = null;
      continue;
    }
    p.name = newName;

    // âš ï¸ ä¸åŠ¨å…¶å®ƒå­—æ®µï¼šè¿™æ ·å®¢æˆ·ç«¯æ‰èƒ½ç»§ç»­æ˜¾ç¤º â€œvless / xudpâ€ã€â€œhy2 / udpâ€
  }

  const out = proxies.filter((p) => p && p.name);
  return ensureUnique(out);
}
