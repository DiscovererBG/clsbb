/**
 * Sub-Store rename.jsï¼ˆç»ˆæé•¿æœŸç‰ˆï½œå›½æ——ä¿®å¤ç‰ˆï¼‰
 *
 * ç»Ÿä¸€è¾“å‡ºï¼š
 *   ğŸ‡¯ğŸ‡µæ—¥æœ¬ä¸œäº¬01-0.1å€ | é«˜é€Ÿ ä¸“çº¿ æ¨è ç”µä¿¡ è”é€š ç§»åŠ¨ IPLC ...
 *
 * âœ… ä¿®å¤ç‚¹ï¼š
 * - å›½æ——è¯†åˆ«æ”¹ä¸ºâ€œæœ€å…¼å®¹â€æ­£åˆ™ï¼ˆé¿å… Sub-Store è¿è¡Œç¯å¢ƒä¸æ”¯æŒ \u{...}ï¼‰
 * - ä¼˜å…ˆä¿ç•™åŸåå›½æ——ï¼ˆæœºåœºè‡ªå¸¦å›½æ——ç»ä¸ä¸¢ï¼‰
 *
 * âœ… å…¶å®ƒèƒ½åŠ›ï¼š
 * - #flag&bl&blgd&nm è¿™ç§å‚æ•°å†™æ³•å¯ç”¨ï¼ˆåªå†™å‚æ•°åä¹Ÿç®—å¼€å¯ï¼‰
 * - ä¸é‡æ’åºå·ï¼šåªå–åŸåæœ«å°¾ 01/02/1/2 -> ä¸¤ä½
 * - å€ç‡ç»Ÿä¸€åˆ°å·¦ä¾§ï¼š0.1å€/2x/x2/2Ã—/Ë£Â²...
 * - æ ‡ç­¾ä¿ç•™ï¼šé«˜é€Ÿ/ä¸“çº¿/æ¨è/è¿è¥å•†/IPLC/IEPL/UDP/GPT/CF/AWS...
 * - ä¸æ”¹å…¶å®ƒå­—æ®µï¼šè®©å®¢æˆ·ç«¯è‡ªåŠ¨æ˜¾ç¤ºåè®®(vless/vmess/hy2/udp...)
 */

const inArg = typeof $arguments !== "undefined" ? $arguments : {};

function isOn(v, defaultVal = true) {
  if (v === undefined) return defaultVal;
  const s = String(v).trim().toLowerCase();
  if (s === "" || s === "1" || s === "true" || s === "on" || s === "yes") return true;
  if (s === "0" || s === "false" || s === "off" || s === "no") return false;
  return true;
}

const nm = isOn(inArg.nm, true);
const addflag = isOn(inArg.flag, true);
const keepRatio = isOn(inArg.bl, true);
const keepTags = isOn(inArg.blgd, true);

const SEP = typeof inArg.sep === "string" ? decodeURI(inArg.sep) : " | ";
const FNAME = inArg.name ? decodeURI(inArg.name) : "";
const nf = isOn(inArg.nf, false);

// ------------------------
// å›½å®¶æ˜ å°„ï¼ˆå¸¸ç”¨ï¼‰
// ------------------------
const ISO2_ZH = {
  HK: "é¦™æ¸¯", MO: "æ¾³é—¨", TW: "å°æ¹¾", JP: "æ—¥æœ¬", KR: "éŸ©å›½", SG: "æ–°åŠ å¡", US: "ç¾å›½",
  GB: "è‹±å›½", UK: "è‹±å›½", DE: "å¾·å›½", FR: "æ³•å›½", IT: "æ„å¤§åˆ©", ES: "è¥¿ç­ç‰™", NL: "è·å…°",
  CH: "ç‘å£«", SE: "ç‘å…¸", NO: "æŒªå¨", DK: "ä¸¹éº¦", FI: "èŠ¬å…°", IE: "çˆ±å°”å…°", PT: "è‘¡è„ç‰™",
  AT: "å¥¥åœ°åˆ©", BE: "æ¯”åˆ©æ—¶", PL: "æ³¢å…°", CZ: "æ·å…‹", HU: "åŒˆç‰™åˆ©", GR: "å¸Œè…Š",
  RO: "ç½—é©¬å°¼äºš", BG: "ä¿åŠ åˆ©äºš", RU: "ä¿„ç½—æ–¯", UA: "ä¹Œå…‹å…°",
  TR: "åœŸè€³å…¶", AE: "é˜¿è”é…‹", SA: "æ²™ç‰¹", IL: "ä»¥è‰²åˆ—", QA: "å¡å¡”å°”", BH: "å·´æ—", OM: "é˜¿æ›¼",
  IN: "å°åº¦", ID: "å°å°¼", VN: "è¶Šå—", TH: "æ³°å›½", MY: "é©¬æ¥è¥¿äºš", PH: "è²å¾‹å®¾",
  AU: "æ¾³å¤§åˆ©äºš", NZ: "æ–°è¥¿å…°", CA: "åŠ æ‹¿å¤§", MX: "å¢¨è¥¿å“¥", BR: "å·´è¥¿",
};

const ENNAME_ISO2 = [
  [/hong\s*kong/i, "HK"],
  [/macao|macau/i, "MO"],
  [/taiwan/i, "TW"],
  [/japan/i, "JP"],
  [/korea|south\s*korea/i, "KR"],
  [/singapore/i, "SG"],
  [/united\s*states|usa\b/i, "US"],
  [/united\s*kingdom|great\s*britain|england|uk\b/i, "GB"],
  [/germany/i, "DE"],
  [/france/i, "FR"],
  [/russia/i, "RU"],
  [/turkey/i, "TR"],
  [/united\s*arab\s*emirates|uae\b|dubai/i, "AE"],
  [/india/i, "IN"],
  [/australia/i, "AU"],
  [/canada/i, "CA"],
];

const CITY_KEYWORDS = [
  "ä¸œäº¬","å¤§é˜ª","æœ­å¹Œ","ç¦å†ˆ",
  "å°åŒ—","æ–°åŒ—","é«˜é›„","å°ä¸­",
  "é¦™æ¸¯","æ¾³é—¨","æ–°åŠ å¡",
  "æ´›æ‰çŸ¶","åœ£ä½•å¡","çº½çº¦","è¥¿é›…å›¾","èŠåŠ å“¥","ç¡…è°·",
  "ä¼¦æ•¦","æ³•å…°å…‹ç¦","å·´é»","é˜¿å§†æ–¯ç‰¹ä¸¹","è‹é»ä¸–",
  "è¿ªæ‹œ","å¤šå“ˆ","åˆ©é›…å¾—",
  "é¦–å°”","é‡œå±±","ä»å·","æ˜¥å·",
  // è‹±æ–‡
  "Los Angeles","San Jose","New York","Seattle","Chicago","Silicon Valley",
  "London","Frankfurt","Paris","Amsterdam","Zurich",
  "Dubai","Doha","Riyadh",
  "Seoul","Busan","Incheon","Chuncheon",
];

const TAG_REGEX = keepTags
  ? /(IPLC|IEPL|ä¸“çº¿|é«˜é€Ÿ|æ¨è|å®¶å®½|å•†å®½|æ¸¸æˆ|Game|AWS|CF|Cloudflare|ç§»åŠ¨|è”é€š|ç”µä¿¡|BGP|CN2|GIA|CMI|CT|CU|CM|UDP|XUDP|QUIC|HY2|Hysteria2|TUIC|REALITY|GPT|Pro|Std|Exp|Biz|Edge|Kern)/ig
  : null;

// ------------------------
// âœ… å›½æ——åŒ¹é…ï¼šæœ€å…¼å®¹å†™æ³•ï¼ˆä¸ç”¨ \u{...}ï¼‰
// ä¸¤ä¸ªâ€œåŒºåŸŸæŒ‡ç¤ºç¬¦â€ç»„æˆå›½æ——
// ------------------------
const FLAG_RE = /(?:\uD83C[\uDDE6-\uDDFF]){2}/g;

function tidy(s) {
  return (s || "")
    .replace(/\s+/g, " ")
    .replace(/\s*\|\s*/g, " | ")
    .trim();
}

function pickFirstFlag(s) {
  const m = (s || "").match(FLAG_RE);
  return m && m[0] ? m[0] : "";
}

function stripAllFlags(s) {
  return (s || "").replace(FLAG_RE, "").trim();
}

function flagToISO2(flag) {
  // flag æ˜¯ä¸¤ä¸ª surrogate pairï¼š\uD83C[\uDDE6-\uDDFF] \uD83C[\uDDE6-\uDDFF]
  if (!flag || flag.length < 4) return "";
  // å–ååŠéƒ¨åˆ†ï¼ˆlow surrogateï¼‰åŒºé—´æ˜ å°„ A-Z
  const a = flag.charCodeAt(1) - 0xDDE6;
  const b = flag.charCodeAt(3) - 0xDDE6;
  if (a < 0 || a > 25 || b < 0 || b > 25) return "";
  return String.fromCharCode(65 + a) + String.fromCharCode(65 + b);
}

function iso2ToFlag(iso2) {
  if (!/^[A-Z]{2}$/.test(iso2)) return "";
  const A = 0xDDE6;
  const a = iso2.charCodeAt(0) - 65;
  const b = iso2.charCodeAt(1) - 65;
  if (a < 0 || a > 25 || b < 0 || b > 25) return "";
  // ç»„åˆæˆä¸¤ä¸ª surrogate pair
  return "\uD83C" + String.fromCharCode(A + a) + "\uD83C" + String.fromCharCode(A + b);
}

function pickRatio(name) {
  if (!keepRatio) return "";
  const n = name || "";

  const sup = n.match(/Ë£[Â²Â³â´âµâ¶â·â¸â¹]|Ë£Â¹â°|Ë£Â²â°|Ë£Â³â°|Ë£â´â°|Ë£âµâ°/);
  if (sup) return sup[0];

  const m1 = n.match(/(\d+(?:\.\d+)?)(?:\s*)(å€|x|X|Ã—)\b/);
  if (m1) {
    const num = m1[1];
    const unit = m1[2];
    if (unit === "å€") return `${num}å€`;
    return `${num}Ã—`;
  }

  const m2 = n.match(/\b(x|X|Ã—)\s*(\d+(?:\.\d+)?)\b/);
  if (m2) return `${m2[2]}Ã—`;

  return "";
}

function pickIndex(name) {
  const n = name || "";
  const m = n.match(/(?:\s|-|_)?(\d{2})(?!\d)\s*$/);
  if (m) return m[1];
  const m2 = n.match(/(?:\s|-|_)?(\d)(?!\d)\s*$/);
  if (m2) return "0" + m2[1];
  return "";
}

function pickTags(name) {
  if (!TAG_REGEX) return "";
  const ms = (name || "").match(TAG_REGEX);
  if (!ms || !ms.length) return "";
  const out = [];
  for (const t of ms) {
    const k = t.toUpperCase();
    if (!out.some(x => x.toUpperCase() === k)) out.push(t);
  }
  return out.join(" ");
}

function pickCity(raw) {
  const s = raw || "";
  for (const k of CITY_KEYWORDS) {
    const re = new RegExp(k.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"), "i");
    if (re.test(s)) return k;
  }
  return "";
}

function detectCountry(rawName) {
  const raw = rawName || "";

  // 1) åŸåå›½æ——ï¼ˆæœ€ç¨³å®šï¼‰
  const rawFlag = pickFirstFlag(raw);
  if (rawFlag) {
    const iso2 = flagToISO2(rawFlag);
    const zh = ISO2_ZH[iso2] || iso2 || "";
    return { iso2, zh, flag: rawFlag, from: "flag" };
  }

  // 2) ISO2
  const iso2Match = raw.match(/\b([A-Z]{2})\b/);
  if (iso2Match) {
    const iso2 = iso2Match[1].toUpperCase();
    const zh = ISO2_ZH[iso2] || iso2;
    const flag = iso2ToFlag(iso2);
    return { iso2, zh, flag, from: "iso2" };
  }

  // 3) è‹±æ–‡å›½å®¶å
  for (const [re, iso2] of ENNAME_ISO2) {
    if (re.test(raw)) {
      const zh = ISO2_ZH[iso2] || iso2;
      const flag = iso2ToFlag(iso2);
      return { iso2, zh, flag, from: "en" };
    }
  }

  // 4) ä¸­æ–‡å…³é”®è¯ï¼ˆå¸¸ç”¨ï¼‰
  const cn = [
    [/é¦™æ¸¯/, "HK"], [/æ¾³é—¨/, "MO"], [/å°æ¹¾|å°åŒ—|æ–°åŒ—|é«˜é›„|å°ä¸­/, "TW"],
    [/æ—¥æœ¬|ä¸œäº¬|å¤§é˜ª|æœ­å¹Œ|ç¦å†ˆ/, "JP"],
    [/æ–°åŠ å¡|ç‹®åŸ/, "SG"],
    [/ç¾å›½|æ´›æ‰çŸ¶|åœ£ä½•å¡|çº½çº¦|è¥¿é›…å›¾|èŠåŠ å“¥|ç¡…è°·/, "US"],
    [/éŸ©å›½|é¦–å°”|é‡œå±±|ä»å·|æ˜¥å·/, "KR"],
    [/è‹±å›½|ä¼¦æ•¦/, "GB"],
    [/å¾·å›½|æ³•å…°å…‹ç¦/, "DE"],
    [/æ³•å›½|å·´é»/, "FR"],
    [/æ¾³å¤§åˆ©äºš|æ‚‰å°¼|å¢¨å°”æœ¬/, "AU"],
    [/è¿ªæ‹œ|é˜¿è”é…‹/, "AE"],
    [/åœŸè€³å…¶|ä¼Šæ–¯å¦å¸ƒå°”/, "TR"],
    [/å°åº¦|å­Ÿä¹°|å¾·é‡Œ/, "IN"],
    [/ä¿„ç½—æ–¯|è«æ–¯ç§‘/, "RU"],
  ];
  for (const [re, iso2] of cn) {
    if (re.test(raw)) {
      const zh = ISO2_ZH[iso2] || iso2;
      const flag = iso2ToFlag(iso2);
      return { iso2, zh, flag, from: "zh" };
    }
  }

  return null;
}

function buildName(oldName) {
  const raw0 = tidy(oldName);
  if (!raw0) return raw0;

  // âœ… å…³é”®ï¼šåŸåè‡ªå¸¦å›½æ——ï¼Œå…ˆæŠ“å‡ºæ¥ï¼Œåé¢ç›´æ¥ç”¨ï¼ˆç»ä¸ä¼šä¸¢ï¼‰
  const originalFlag = pickFirstFlag(raw0);

  // å»æ‰åŸåæ‰€æœ‰å›½æ——ï¼ˆé˜²é‡å¤å †å ï¼‰
  const rawNoFlag = tidy(stripAllFlags(raw0));

  const info = detectCountry(raw0);
  const idx = pickIndex(rawNoFlag);
  const ratio = pickRatio(rawNoFlag);
  const tags = pickTags(rawNoFlag);

  let desc = rawNoFlag;

  if (ratio) {
    const esc = ratio.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    desc = desc.replace(new RegExp(esc, "g"), "");
  }
  if (idx) desc = desc.replace(new RegExp(`(?:\\s|-|_)?${idx}(?!\\d)\\s*$`), "");

  if (info) {
    if (info.zh && info.zh !== info.iso2) desc = desc.replace(new RegExp(info.zh, "g"), "");
    if (info.iso2) desc = desc.replace(new RegExp(`\\b${info.iso2}\\b`, "g"), "");
  }

  desc = tidy(desc).replace(/^\||\|$/g, "").trim();

  if (tags) desc = tidy(desc ? `${desc} ${tags}` : tags);

  // æœªè¯†åˆ«å›½å®¶ï¼šä¸ä¸¢ï¼ˆnm=trueï¼‰ï¼Œç›´æ¥ä¿ç•™åŸå
  if (!info) {
    const fallback = FNAME ? `${FNAME} ${rawNoFlag}` : rawNoFlag;
    return nm ? tidy(fallback) : null;
  }

  const city = pickCity(raw0);
  const region = `${info.zh}${city && !String(city).includes(info.zh) ? city : ""}`;

  // âœ… å›½æ——æœ€ç»ˆç­–ç•¥ï¼š
  // - å¦‚æœåŸåæœ‰å›½æ——ï¼šç”¨åŸæ¥çš„ï¼ˆæœ€ç¬¦åˆâ€œæœºåœºåŸºç¡€è¾“å‡ºâ€ï¼‰
  // - å¦åˆ™ï¼šç”¨è¯†åˆ«ç”Ÿæˆçš„
  const flag = addflag ? (originalFlag || info.flag || "") : "";

  const ratioPart = ratio ? `-${ratio}` : "";
  const left = `${flag}${region}${idx ? idx : ""}${ratioPart}`;

  let finalName = `${left}${SEP}${desc || region}`;

  if (FNAME) finalName = nf ? `${FNAME} ${finalName}` : `${FNAME} ${finalName}`;

  return tidy(finalName);
}

function ensureUnique(list) {
  const seen = new Map();
  for (const p of list) {
    const n = p.name;
    const c = seen.get(n) || 0;
    if (c === 0) seen.set(n, 1);
    else {
      seen.set(n, c + 1);
      p.name = `${n}#${c + 1}`;
    }
  }
  return list;
}

function operator(proxies) {
  if (!Array.isArray(proxies)) return proxies;

  for (const p of proxies) {
    if (!p || !p.name) continue;
    const newName = buildName(p.name);
    if (newName === null) {
      p.name = null;
      continue;
    }
    // åªæ”¹ nameï¼Œä¸åŠ¨å…¶å®ƒå­—æ®µï¼ˆåè®®æ˜¾ç¤ºç”±å®¢æˆ·ç«¯å®Œæˆï¼‰
    p.name = newName;
  }

  const out = proxies.filter(p => p && p.name);
  return ensureUnique(out);
}
