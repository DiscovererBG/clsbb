/**
 * Sub-Store rename.jsï¼ˆé•¿æœŸç‰ˆ / ç»ˆç‰ˆæ€è·¯ï¼‰
 * ç›®æ ‡è¾“å‡ºï¼šğŸ‡¯ğŸ‡µæ—¥æœ¬ä¸œäº¬01-0.1å€ | é«˜é€Ÿä¸“çº¿æ¨è
 * å…³é”®ï¼š
 * 1) ä¸åšå…¨å±€é‡æ–°ç¼–å·ï¼ˆè§£å†³ä½ â€œåºå·å’ŒåŸå§‹ä¸ä¸€è‡´â€ï¼‰
 * 2) å›½æ——ï¼šèƒ½è¯†åˆ«å›½å®¶å°±åŠ ï¼›è¯†åˆ«ä¸åˆ°ä¹Ÿä¸éšè—ï¼ˆé»˜è®¤ nm=trueï¼‰
 * 3) å€ç‡ï¼šå°½é‡ä»åŸåé‡Œæå–å¹¶åŸæ ·ä¿ç•™ï¼ˆ0.1å€ / 2Ã— / x2 / Ë£Â² â€¦ï¼‰
 * 4) åç¼€ï¼šé«˜é€Ÿ/ä¸“çº¿/æ¨è/AWS/ç§»åŠ¨è”é€šç”µä¿¡/IPLC/IEPL/å®¶å®½â€¦å…¨éƒ¨ä¿ç•™
 */

// Sub-Store ä¼šæ³¨å…¥ $arguments
const inArg = typeof $arguments !== "undefined" ? $arguments : {};

// ===== é»˜è®¤å‚æ•°ï¼ˆä½ è¦â€œä»¥åä¸ç”¨æ”¹â€ï¼Œæ‰€ä»¥é»˜è®¤å°±å¼€åˆ°ä½ æƒ³è¦çš„æ•ˆæœï¼‰ =====
const nm = inArg.nm !== undefined ? !!inArg.nm : true;          // æœªåŒ¹é…ä¹Ÿä¿ç•™
const addflag = inArg.flag !== undefined ? !!inArg.flag : true; // é»˜è®¤åŠ å›½æ——
const keepRatio = inArg.bl !== undefined ? !!inArg.bl : true;   // é»˜è®¤ä¿ç•™å€ç‡
const keepTags = inArg.blgd !== undefined ? !!inArg.blgd : true;// é»˜è®¤ä¿ç•™ IPLC/IEPL/å®¶å®½/ä¸“çº¿/UDP/GPT ç­‰æ ‡ç­¾

// åˆ†éš”ç¬¦
const SEP = " | "; // å›ºå®šç”¨ä½ å–œæ¬¢çš„æ ·å¼
const FNAME = inArg.name ? decodeURI(inArg.name) : "";
const nf = !!inArg.nf; // name= å‰ç¼€æ”¾æœ€å‰

// ===== å›½å®¶è¯†åˆ«è§„åˆ™ï¼ˆå°½é‡è¦†ç›– + é¿å…è¯¯åˆ¤ï¼šç¼©å†™ç”¨ \b è¾¹ç•Œï¼‰ =====
// ä½ ä»¥åçœŸé‡åˆ°â€œæ–°å›½å®¶â€ï¼Œåªè¦æœºåœºåå­—é‡Œå¸¦å›½å®¶/åŸå¸‚/ç¼©å†™ï¼Œè¿™é‡Œå¤§æ¦‚ç‡å°±èƒ½è¯†åˆ«ï¼›
// å¦‚æœæœºåœºåå­—å®Œå…¨ä¸å†™å›½å®¶ï¼Œé‚£ä»»ä½•è„šæœ¬éƒ½æ²¡æ³•å‡­ç©ºçŒœã€‚
const COUNTRY = [
  // å¸¸ç”¨ä¼˜å…ˆ
  { re: /(é¦™æ¸¯|Hong\s?Kong|\bHK\b|HKG|ğŸ‡­ğŸ‡°)/i, name: "é¦™æ¸¯", flag: "ğŸ‡­ğŸ‡°" },
  { re: /(æ¾³é—¨|Macao|\bMO\b|MAC|ğŸ‡²ğŸ‡´)/i, name: "æ¾³é—¨", flag: "ğŸ‡²ğŸ‡´" },
  { re: /(å°æ¹¾|Taiwan|\bTW\b|TPE|Taipei|æ–°åŒ—|å°åŒ—|é«˜é›„|ğŸ‡¹ğŸ‡¼|ğŸ‡¨ğŸ‡³.*å°æ¹¾|å°æ¹¾.*ğŸ‡¨ğŸ‡³)/i, name: "å°æ¹¾", flag: "ğŸ‡¹ğŸ‡¼" },
  { re: /(æ—¥æœ¬|Japan|\bJP\b|Tokyo|ä¸œäº¬|Osaka|å¤§é˜ª|Nagoya|åå¤å±‹|Sapporo|æœ­å¹Œ|Fukuoka|ç¦å†ˆ|ğŸ‡¯ğŸ‡µ)/i, name: "æ—¥æœ¬", flag: "ğŸ‡¯ğŸ‡µ" },
  { re: /(æ–°åŠ å¡|Singapore|\bSG\b|SGP|ç‹®åŸ|ğŸ‡¸ğŸ‡¬)/i, name: "æ–°åŠ å¡", flag: "ğŸ‡¸ğŸ‡¬" },
  { re: /(ç¾å›½|United\s?States|\bUS\b|USA|Los\s?Angeles|\bLA\b|San\s?Jose|SJ|New\s?York|NY|Dallas|D.C|Washington|ç¡…è°·|è¥¿é›…å›¾|èŠåŠ å“¥|çº½çº¦|æ´›æ‰çŸ¶|ğŸ‡ºğŸ‡¸)/i, name: "ç¾å›½", flag: "ğŸ‡ºğŸ‡¸" },
  { re: /(éŸ©å›½|Korea|\bKR\b|Seoul|é¦–å°”|æ˜¥å·|é‡œå±±|ğŸ‡°ğŸ‡·)/i, name: "éŸ©å›½", flag: "ğŸ‡°ğŸ‡·" },

  // å¸¸è§æ‰©å±•ï¼ˆæµåª’ä½“/æœºåœºå¸¸å‡ºç°ï¼‰
  { re: /(è‹±å›½|United\s?Kingdom|\bUK\b|London|ä¼¦æ•¦|ğŸ‡¬ğŸ‡§)/i, name: "è‹±å›½", flag: "ğŸ‡¬ğŸ‡§" },
  { re: /(å¾·å›½|Germany|\bDE\b|Frankfurt|æ³•å…°å…‹ç¦|ğŸ‡©ğŸ‡ª)/i, name: "å¾·å›½", flag: "ğŸ‡©ğŸ‡ª" },
  { re: /(æ³•å›½|France|\bFR\b|Paris|å·´é»|ğŸ‡«ğŸ‡·)/i, name: "æ³•å›½", flag: "ğŸ‡«ğŸ‡·" },
  { re: /(æ¾³å¤§åˆ©äºš|Australia|\bAU\b|Sydney|æ‚‰å°¼|Melbourne|å¢¨å°”æœ¬|ğŸ‡¦ğŸ‡º)/i, name: "æ¾³å¤§åˆ©äºš", flag: "ğŸ‡¦ğŸ‡º" },
  { re: /(é˜¿è”é…‹|Dubai|UAE|\bAE\b|Abu\s?Dhabi|è¿ªæ‹œ|ğŸ‡¦ğŸ‡ª)/i, name: "é˜¿è”é…‹", flag: "ğŸ‡¦ğŸ‡ª" },
  { re: /(åœŸè€³å…¶|Turkey|\bTR\b|Istanbul|ä¼Šæ–¯å¦å¸ƒå°”|ğŸ‡¹ğŸ‡·)/i, name: "åœŸè€³å…¶", flag: "ğŸ‡¹ğŸ‡·" },
  { re: /(å°åº¦|India|\bIN\b|Mumbai|å­Ÿä¹°|Delhi|å¾·é‡Œ|ğŸ‡®ğŸ‡³)/i, name: "å°åº¦", flag: "ğŸ‡®ğŸ‡³" },
  { re: /(åŠ æ‹¿å¤§|Canada|\bCA\b|Toronto|å¤šä¼¦å¤š|Vancouver|æ¸©å“¥å|Montreal|è’™ç‰¹åˆ©å°”|ğŸ‡¨ğŸ‡¦)/i, name: "åŠ æ‹¿å¤§", flag: "ğŸ‡¨ğŸ‡¦" },
  { re: /(è·å…°|Netherlands|\bNL\b|Amsterdam|é˜¿å§†æ–¯ç‰¹ä¸¹|ğŸ‡³ğŸ‡±)/i, name: "è·å…°", flag: "ğŸ‡³ğŸ‡±" },
  { re: /(ç‘å£«|Switzerland|\bCH\b|Zurich|è‹é»ä¸–|ğŸ‡¨ğŸ‡­)/i, name: "ç‘å£«", flag: "ğŸ‡¨ğŸ‡­" },
  { re: /(è¥¿ç­ç‰™|Spain|\bES\b|Madrid|é©¬å¾·é‡Œ|Barcelona|å·´å¡ç½—é‚£|ğŸ‡ªğŸ‡¸)/i, name: "è¥¿ç­ç‰™", flag: "ğŸ‡ªğŸ‡¸" },
  { re: /(æ„å¤§åˆ©|Italy|\bIT\b|Milan|ç±³å…°|Rome|ç½—é©¬|ğŸ‡®ğŸ‡¹)/i, name: "æ„å¤§åˆ©", flag: "ğŸ‡®ğŸ‡¹" },

  // ä¸œå—äºšå¸¸è§
  { re: /(é©¬æ¥è¥¿äºš|Malaysia|\bMY\b|Kuala\s?Lumpur|å‰éš†å¡|ğŸ‡²ğŸ‡¾)/i, name: "é©¬æ¥è¥¿äºš", flag: "ğŸ‡²ğŸ‡¾" },
  { re: /(æ³°å›½|Thailand|\bTH\b|Bangkok|æ›¼è°·|ğŸ‡¹ğŸ‡­)/i, name: "æ³°å›½", flag: "ğŸ‡¹ğŸ‡­" },
  { re: /(è¶Šå—|Vietnam|\bVN\b|Hanoi|æ²³å†…|HCM|èƒ¡å¿—æ˜|ğŸ‡»ğŸ‡³)/i, name: "è¶Šå—", flag: "ğŸ‡»ğŸ‡³" },
  { re: /(å°å°¼|Indonesia|\bID\b|Jakarta|é›…åŠ è¾¾|ğŸ‡®ğŸ‡©)/i, name: "å°å°¼", flag: "ğŸ‡®ğŸ‡©" },
  { re: /(è²å¾‹å®¾|Philippines|\bPH\b|Manila|é©¬å°¼æ‹‰|ğŸ‡µğŸ‡­)/i, name: "è²å¾‹å®¾", flag: "ğŸ‡µğŸ‡­" },

  // å…œåº•ï¼šä¿„ç½—æ–¯
  { re: /(ä¿„ç½—æ–¯|Russia|\bRU\b|Moscow|è«æ–¯ç§‘|ğŸ‡·ğŸ‡º)/i, name: "ä¿„ç½—æ–¯", flag: "ğŸ‡·ğŸ‡º" },
];

// ===== æ ‡ç­¾ä¿ç•™ï¼ˆä½ æœºåœºé‚£ç§â€œé«˜é€Ÿ/ä¸“çº¿/æ¨è/è¿è¥å•†/AWS/IPLC/IEPL/å®¶å®½/UDP/GPTâ€ç­‰ï¼‰=====
const TAG_REGEX = keepTags
  ? /(IPLC|IEPL|ä¸“çº¿|é«˜é€Ÿ|æ¨è|å®¶å®½|å•†å®½|æ¸¸æˆ|Game|AWS|CF|Cloudflare|ç§»åŠ¨|è”é€š|ç”µä¿¡|BGP|CN2|GIA|CMI|CU|CT|CM|UDP|XUDP|QUIC|HY2|Hysteria2|TUIC|REALITY|GPT)/ig
  : null;

// ===== å€ç‡æå–ï¼ˆå°½é‡åŸæ ·ä¿ç•™ï¼‰=====
// æ”¯æŒï¼š0.1å€ / 2å€ / 2x / x2 / 2Ã— / Ë£Â² / 0.1X ç­‰
function pickRatio(name) {
  if (!keepRatio) return "";
  const m =
    name.match(/(\d+(?:\.\d+)?\s*(?:å€|x|X|Ã—))/) ||
    name.match(/(?:x|X|Ã—)\s*(\d+(?:\.\d+)?)/) ||
    name.match(/Ë£[Â²Â³â´âµâ¶â·â¸â¹]|Ë£Â¹â°|Ë£Â²â°|Ë£Â³â°|Ë£â´â°|Ë£âµâ°/);
  if (!m) return "";
  // ç»Ÿä¸€ä¸€äº›å†™æ³•ï¼šå¦‚æœæ˜¯ x2 è¿™ç§ï¼Œå°½é‡å˜æˆ 2Ã—ï¼›å¦‚æœåŸæ¥å°±æ˜¯â€œ0.1å€â€å°±ä¸åŠ¨
  const raw = m[0].replace(/\s+/g, "");
  if (/^(x|X|Ã—)\d/.test(raw)) return raw.replace(/^(x|X)/, "") + "Ã—";
  if (/^\d+(\.\d+)?(x|X)$/.test(raw)) return raw.replace(/(x|X)$/, "Ã—");
  return raw;
}

// ===== åºå·æå–ï¼šä¼˜å…ˆä¿ç•™åŸåæœ«å°¾çš„ 01/02/â€¦ï¼ˆä¸åšå…¨å±€é‡æ’ï¼‰=====
function pickIndex(name) {
  // å¸¸è§ï¼š"... 01" æˆ– "...-01" æˆ– "..._01" æˆ– "...01"
  const m = name.match(/(?:\s|-|_)?(\d{2})(?!\d)(?:\s*$)/);
  if (m) return m[1];
  // æœ‰äº›æ˜¯ 1/2/3ï¼ˆå•æ•°å­—ï¼‰ä¹Ÿè¡¥ 0
  const m2 = name.match(/(?:\s|-|_)?(\d)(?!\d)(?:\s*$)/);
  if (m2) return "0" + m2[1];
  return "";
}

// ===== æ¸…ç†å¤šä½™ç¬¦å· =====
function tidy(s) {
  return (s || "")
    .replace(/\s+/g, " ")
    .replace(/\s*\|\s*/g, " | ")
    .trim();
}

// ===== å»æ‰å·²æœ‰å›½æ——ï¼ˆé¿å…é‡å¤ï¼‰ï¼Œä½†æœ€ç»ˆä¼šæŒ‰è¯†åˆ«ç»“æœå†åŠ  =====
function stripFlags(s) {
  return s.replace(/[\u{1F1E6}-\u{1F1FF}]{2}/gu, "").trim();
}

// ===== è¯†åˆ«å›½å®¶ï¼ˆè¿”å› {name, flag} æˆ– nullï¼‰=====
function detectCountry(name) {
  for (const c of COUNTRY) {
    if (c.re.test(name)) return { name: c.name, flag: c.flag };
  }
  return null;
}

// ===== ä¿ç•™æ ‡ç­¾ä¸²ï¼ˆæŒ‰åŸåæå–ï¼‰=====
function pickTags(name) {
  if (!TAG_REGEX) return "";
  const ms = name.match(TAG_REGEX);
  if (!ms || !ms.length) return "";
  // å»é‡ä¿æŒé¡ºåº
  const out = [];
  for (const t of ms) {
    const k = t.toUpperCase();
    if (!out.map(x => x.toUpperCase()).includes(k)) out.push(t);
  }
  // ä½ æœºåœºå¸¸è§æ˜¯â€œç”µä¿¡è”é€šç§»åŠ¨æ¨è/é«˜é€Ÿä¸“çº¿â€ç­‰ï¼Œæœ¬è„šæœ¬ä¸å¼ºåˆ¶é¡ºåºï¼Œä¿ç•™åŸå‡ºç°é¡ºåº
  return out.join("");
}

// ===== æ„é€ æœ€ç»ˆåå­— =====
function buildName(oldName) {
  let name = tidy(oldName);
  const raw = name;

  // å…ˆå‰¥ç¦»å›½æ——ï¼ˆæœ€ç»ˆç»Ÿä¸€ç”±è¯†åˆ«ç»“æœå†³å®šæ˜¯å¦åŠ ï¼‰
  name = stripFlags(name);

  const info = detectCountry(name);

  const idx = pickIndex(name);
  const ratio = pickRatio(name);
  const tags = pickTags(name);

  // æè¿°ï¼šæŠŠå›½å®¶ç›¸å…³è¯ã€å€ç‡ã€æœ«å°¾åºå·ã€å›½æ——éƒ½å°½é‡å‰”æ‰ï¼Œå‰©ä¸‹åšæè¿°
  let desc = name;

  if (info) {
    desc = desc.replace(info.name, ""); // å»æ‰ä¸­æ–‡å›½å®¶å
  }
  // å»æ‰å¸¸è§è‹±æ–‡å›½å®¶/ç¼©å†™/åŸå¸‚ï¼ˆåªåšâ€œè½»å‰”é™¤â€ï¼Œé¿å…å‰”å¤ªç‹ ï¼‰
  desc = desc
    .replace(/\b(HK|TW|JP|SG|US|UK|KR|TR|AE|AU|CA|NL|DE|FR|IT|ES|RU|IN|ID|VN|TH|MY|PH)\b/gi, "")
    .replace(/Hong\s?Kong|Taiwan|Japan|Singapore|United\s?States|United\s?Kingdom|Korea|Turkey|Dubai|UAE|Australia|Canada|Netherlands|Germany|France|Italy|Spain|Russia|India|Indonesia|Vietnam|Thailand|Malaysia|Philippines/gi, "");

  // å»å€ç‡
  if (ratio) {
    const r = ratio.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    desc = desc.replace(new RegExp(r, "g"), "");
  }
  // å»æ‰æœ«å°¾åºå·
  if (idx) {
    desc = desc.replace(new RegExp(`(?:\\s|-|_)?${idx}(?:\\s*$)`), "");
  }

  // æ¸…ç†åˆ†éš”ç¬¦æ®‹ç•™
  desc = tidy(desc).replace(/^\||\|$/g, "").trim();

  // å¦‚æœæ ‡ç­¾å­˜åœ¨ä½†æè¿°é‡Œæ²¡ç•™ä¸‹â€œé«˜é€Ÿ/ä¸“çº¿/æ¨èâ€ç­‰ï¼Œä¹ŸæŠŠæ ‡ç­¾æ‹¼å›æè¿°ï¼ˆé¿å…ä¸¢ï¼‰
  // tags æ˜¯è¿ç€çš„å­—ç¬¦ä¸²ï¼Œæ¯”å¦‚ "é«˜é€Ÿä¸“çº¿æ¨è"ï¼Œè¿™é‡Œæ›´è‡ªç„¶çš„æ”¾åˆ°æè¿°é‡Œ
  if (tags && !desc.includes(tags)) {
    // å¦‚æœ desc ä¸ºç©ºï¼Œå°±ç›´æ¥ç”¨ tags
    desc = desc ? `${desc}` : `${tags}`;
  }

  // å¦‚æœæè¿°æœ€åè¿˜æ˜¯ç©ºï¼šç”¨åŸåå…œåº•ï¼ˆé¿å…è¾“å‡ºæ€ªåå­—ï¼‰
  if (!desc) desc = tidy(stripFlags(raw));

  // ç»„è£…â€œåœ°åŒºåâ€ï¼šä½ å–œæ¬¢â€œæ—¥æœ¬ä¸œäº¬â€è¿™ç§æ•ˆæœï¼Œè„šæœ¬ä¸ä¼šå¼ºè¡Œåªç•™â€œæ—¥æœ¬â€
  // å¦‚æœåŸåé‡Œæœ‰â€œä¸œäº¬/å¤§é˜ª/æ–°åŠ å¡/AWSæ–°åŠ å¡â€ç­‰ï¼Œdesc ä¼šä¿ç•™ï¼Œæ‰€ä»¥åœ°åŒºè¿™é‡Œç”¨â€œå›½å®¶åâ€ä¸ºä¸»
  // â€”â€”ä½ è¦çš„æ•ˆæœæ˜¯ï¼šğŸ‡¯ğŸ‡µæ—¥æœ¬ä¸œäº¬01 | é«˜é€Ÿä¸“çº¿æ¨è
  // æ‰€ä»¥ï¼šåœ°åŒº = å›½å®¶å + ï¼ˆå¦‚æœåŸåé‡Œæœ‰åŸå¸‚å…³é”®è¯ï¼Œä¼˜å…ˆä»åŸåé‡ŒæŠ“ä¸€ä¸ªï¼‰
  let city = "";
  if (info) {
    const cityMatch =
      raw.match(/(ä¸œäº¬|å¤§é˜ª|åå¤å±‹|æœ­å¹Œ|ç¦å†ˆ|é¦–å°”|é‡œå±±|æ–°åŒ—|å°åŒ—|é«˜é›„|æ´›æ‰çŸ¶|åœ£ä½•å¡|çº½çº¦|è¥¿é›…å›¾|èŠåŠ å“¥|ä¼¦æ•¦|æ³•å…°å…‹ç¦|å·´é»|æ‚‰å°¼|å¢¨å°”æœ¬|è¿ªæ‹œ|å¤šä¼¦å¤š|æ¸©å“¥å|é˜¿å§†æ–¯ç‰¹ä¸¹|è«æ–¯ç§‘|æ›¼è°·|æ²³å†…|é›…åŠ è¾¾|é©¬å°¼æ‹‰)/);
    if (cityMatch) city = cityMatch[1];
  }

  let region = info ? `${info.name}${city}` : "";

  // å€ç‡æ‹¼æ¥æ ·å¼ï¼šåƒä½ æˆªå›¾ â€œç¾å›½01-0.1å€ | â€¦â€
  const ratioPart = ratio ? `-${ratio}` : "";

  // æœ€ç»ˆ name å‰ç¼€
  let prefix = "";
  if (FNAME) {
    prefix = nf ? `${FNAME}` : "";
  }

  // å›½æ——ï¼šå¦‚æœè¯†åˆ«åˆ°å›½å®¶æ‰åŠ ï¼›è¯†åˆ«ä¸åˆ°ä¸ä¹±åŠ 
  const flag = addflag && info ? info.flag : "";

  // ç»„è£…ä¸»æ ‡é¢˜ï¼ˆå·¦ä¾§ï¼‰
  let left;
  if (info) {
    // å›½å®¶å­˜åœ¨ï¼šğŸ‡¯ğŸ‡µæ—¥æœ¬ä¸œäº¬01-0.1å€
    left = `${flag}${region}${idx ? idx : ""}${ratioPart}`;
  } else {
    // æ²¡åŒ¹é…åˆ°å›½å®¶ï¼šä¿ç•™åŸåï¼ˆä¸éšè—ï¼‰
    left = tidy(stripFlags(raw));
  }

  // æ‹¼æ¥æè¿°ï¼ˆå³ä¾§ï¼‰
  let finalName = info ? `${left}${SEP}${desc}` : left;

  // å‰ç¼€ name=ï¼ˆä½ ä¸ç”¨ä¹Ÿè¡Œï¼‰
  if (FNAME && !nf) finalName = `${FNAME} ${finalName}`;
  if (FNAME && nf) finalName = `${prefix} ${finalName}`;

  return tidy(finalName);
}

// ===== ä¿è¯åå­—å”¯ä¸€ï¼ˆClash ç³»éœ€è¦å”¯ä¸€ï¼Œå¦åˆ™ä¼šæŠ¥é”™/è¦†ç›–ï¼‰=====
function ensureUnique(list) {
  const seen = new Map();
  for (const p of list) {
    const n = p.name;
    const c = seen.get(n) || 0;
    if (c === 0) {
      seen.set(n, 1);
    } else {
      seen.set(n, c + 1);
      p.name = `${n}#${c + 1}`;
    }
  }
  return list;
}

// ===== Sub-Store å…¥å£ï¼šoperator(proxies) =====
function operator(proxies) {
  if (!Array.isArray(proxies)) return proxies;

  for (const p of proxies) {
    if (!p || !p.name) continue;
    const newName = buildName(p.name);
    if (newName) p.name = newName;
    // ä¸åŠ¨å…¶å®ƒå­—æ®µï¼ˆtype / udp / reality / flow / etcï¼‰ï¼Œä¿è¯åè®®æ˜¾ç¤ºç”±å®¢æˆ·ç«¯è‡ªåŠ¨å±•ç¤º
  }
  return ensureUnique(proxies);
}
