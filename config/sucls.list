/**
 * Sub-Store rename.jsï¼ˆæžè‡´ç‰ˆ / é•¿æœŸä½¿ç”¨ï¼‰
 * è¾“å‡ºé£Žæ ¼ï¼šðŸ‡ºðŸ‡¸ç¾Žå›½æ´›æ‰çŸ¶01-0.1å€ | ç”µä¿¡è”é€šç§»åŠ¨æŽ¨è é«˜é€Ÿä¸“çº¿
 *
 * âœ… å›½æ——è¯†åˆ«ï¼ˆæ”¯æŒæ–°å›½å®¶è‡ªåŠ¨é€‚é…ï¼šåªè¦æœºåœºåå­—é‡Œå¸¦å›½æ——ï¼‰
 * âœ… ISO ä¸¤ä½ç è¯†åˆ«ï¼ˆUS/JP/SG...ï¼‰
 * âœ… ä¸­è‹±æ–‡å›½å®¶å/å¸¸è§åŸŽå¸‚è¯†åˆ«
 * âœ… åºå·ä¸é‡æŽ’ï¼šåªå–åŽŸåæœ«å°¾ 01/02...
 * âœ… å€çŽ‡ä¿ç•™ï¼š0.1å€/2Ã—/x2/Ë£Â²...
 * âœ… æ ‡ç­¾ä¿ç•™ï¼šé«˜é€Ÿ/ä¸“çº¿/æŽ¨è/AWS/IPLC/IEPL/å®¶å®½/UDP/GPT...
 *
 * Sub-Store çŽ¯å¢ƒï¼šæä¾› $argumentsï¼Œå…¥å£å‡½æ•° operator(proxies)
 */

const inArg = typeof $arguments !== "undefined" ? $arguments : {};

// ===== é»˜è®¤â€œä½ è¦çš„æ•ˆæžœâ€å…¨éƒ¨å¼€å¯ =====
const nm = inArg.nm !== undefined ? !!inArg.nm : true;          // æœªåŒ¹é…ä¹Ÿä¿ç•™
const addflag = inArg.flag !== undefined ? !!inArg.flag : true; // é»˜è®¤åŠ å›½æ——ï¼ˆè¯†åˆ«åˆ°æ‰åŠ ï¼‰
const keepRatio = inArg.bl !== undefined ? !!inArg.bl : true;   // é»˜è®¤ä¿ç•™å€çŽ‡
const keepTags = inArg.blgd !== undefined ? !!inArg.blgd : true;// é»˜è®¤ä¿ç•™æ ‡ç­¾
const SEP = typeof inArg.sep === "string" ? decodeURI(inArg.sep) : " | ";
const FNAME = inArg.name ? decodeURI(inArg.name) : "";
const nf = !!inArg.nf;

// ===== ISO ä¸¤ä½å›½å®¶ç  -> ä¸­æ–‡åï¼ˆè¦†ç›–å¸¸ç”¨+æµåª’ä½“å¸¸è§ï¼‰=====
// æžè‡´ç‰ˆä¸æŠŠ 200+ å…¨å¡žè¿›æ¥ï¼ˆå¤ªé•¿ï¼‰ï¼Œä½†ï¼š
// - ä½ æœºåœºå‡ºçŽ°çš„æ–°å›½å®¶ï¼šå¦‚æžœå¸¦å›½æ——âœ…è‡ªåŠ¨è¯†åˆ«
// - å¦‚æžœåªå†™ ISO ä¸¤ä½ç ï¼ˆæ¯”å¦‚ CAï¼‰ï¼šä¸åœ¨è¡¨é‡Œå°±æ˜¾ç¤ºâ€œCAâ€ï¼Œä¹Ÿä¸ä¼šä¸¢
const ISO2_ZH = {
  HK: "é¦™æ¸¯", MO: "æ¾³é—¨", TW: "å°æ¹¾", JP: "æ—¥æœ¬", KR: "éŸ©å›½", SG: "æ–°åŠ å¡", US: "ç¾Žå›½",
  GB: "è‹±å›½", UK: "è‹±å›½", DE: "å¾·å›½", FR: "æ³•å›½", IT: "æ„å¤§åˆ©", ES: "è¥¿ç­ç‰™", NL: "è·å…°",
  CH: "ç‘žå£«", SE: "ç‘žå…¸", NO: "æŒªå¨", DK: "ä¸¹éº¦", FI: "èŠ¬å…°", IE: "çˆ±å°”å…°", PT: "è‘¡è„ç‰™",
  AT: "å¥¥åœ°åˆ©", BE: "æ¯”åˆ©æ—¶", PL: "æ³¢å…°", CZ: "æ·å…‹", HU: "åŒˆç‰™åˆ©", GR: "å¸Œè…Š",
  RO: "ç½—é©¬å°¼äºš", BG: "ä¿åŠ åˆ©äºš", RU: "ä¿„ç½—æ–¯", UA: "ä¹Œå…‹å…°",
  TR: "åœŸè€³å…¶", AE: "é˜¿è”é…‹", SA: "æ²™ç‰¹", IL: "ä»¥è‰²åˆ—", QA: "å¡å¡”å°”", BH: "å·´æž—", OM: "é˜¿æ›¼",
  IN: "å°åº¦", ID: "å°å°¼", VN: "è¶Šå—", TH: "æ³°å›½", MY: "é©¬æ¥è¥¿äºš", PH: "è²å¾‹å®¾",
  AU: "æ¾³å¤§åˆ©äºš", NZ: "æ–°è¥¿å…°", CA: "åŠ æ‹¿å¤§", MX: "å¢¨è¥¿å“¥", BR: "å·´è¥¿", AR: "é˜¿æ ¹å»·", CL: "æ™ºåˆ©",
  ZA: "å—éž", EG: "åŸƒåŠ", KE: "è‚¯å°¼äºš",
};

// ===== å¸¸è§è‹±æ–‡å›½å®¶å -> ISO2ï¼ˆç”¨äºŽä»Žè‹±æ–‡å…¨ç§°è¯†åˆ«ï¼‰=====
const ENNAME_ISO2 = [
  [/hong\s*kong/i, "HK"],
  [/macao|macau/i, "MO"],
  [/taiwan/i, "TW"],
  [/japan/i, "JP"],
  [/korea|south\s*korea/i, "KR"],
  [/singapore/i, "SG"],
  [/united\s*states|usa\b/i, "US"],
  [/united\s*kingdom|great\s*britain|england|uk\b/i, "GB"],
  [/germany/i, "DE"],
  [/france/i, "FR"],
  [/italy/i, "IT"],
  [/spain/i, "ES"],
  [/netherlands|holland/i, "NL"],
  [/switzerland/i, "CH"],
  [/russia/i, "RU"],
  [/turkey/i, "TR"],
  [/united\s*arab\s*emirates|uae\b|dubai/i, "AE"],
  [/india/i, "IN"],
  [/indonesia/i, "ID"],
  [/vietnam/i, "VN"],
  [/thailand/i, "TH"],
  [/malaysia/i, "MY"],
  [/philippines/i, "PH"],
  [/australia/i, "AU"],
  [/new\s*zealand/i, "NZ"],
  [/canada/i, "CA"],
];

// ===== åŸŽå¸‚/çº¿è·¯å…³é”®è¯ï¼ˆç”¨äºŽâ€œå›½å®¶+åŸŽå¸‚â€æ‹¼æŽ¥ï¼‰=====
const CITY_KEYWORDS = [
  // JP
  "ä¸œäº¬","å¤§é˜ª","åå¤å±‹","æœ­å¹Œ","ç¦å†ˆ","å†²ç»³",
  // TW
  "å°åŒ—","æ–°åŒ—","æ¡ƒå›­","å°ä¸­","é«˜é›„",
  // HK
  "ä¸­çŽ¯","ä¹é¾™","æ²™ç”°",
  // SG
  "æ–°åŠ å¡",
  // US
  "æ´›æ‰çŸ¶","åœ£ä½•å¡ž","çº½çº¦","è¥¿é›…å›¾","èŠåŠ å“¥","è¾¾æ‹‰æ–¯","åŽç››é¡¿","ç¡…è°·","æ³¢ç‰¹å…°",
  "Los Angeles","San Jose","New York","Seattle","Chicago","Dallas","Washington","Silicon Valley","Portland",
  // EU
  "ä¼¦æ•¦","æ³•å…°å…‹ç¦","å·´é»Ž","é˜¿å§†æ–¯ç‰¹ä¸¹","è‹é»Žä¸–","é©¬å¾·é‡Œ","ç±³å…°","ç½—é©¬",
  "London","Frankfurt","Paris","Amsterdam","Zurich","Madrid","Milan","Rome",
  // ME
  "è¿ªæ‹œ","é˜¿å¸ƒæ‰Žæ¯”","å¤šå“ˆ","åˆ©é›…å¾—",
  "Dubai","Abu Dhabi","Doha","Riyadh",
  // SEA
  "æ›¼è°·","æ²³å†…","èƒ¡å¿—æ˜Ž","é›…åŠ è¾¾","é©¬å°¼æ‹‰","å‰éš†å¡",
  "Bangkok","Hanoi","Ho Chi Minh","Jakarta","Manila","Kuala Lumpur",
  // KR
  "é¦–å°”","é‡œå±±","æ˜¥å·","ä»å·",
  "Seoul","Busan","Incheon","Chuncheon",
];

// ===== æ ‡ç­¾ä¿ç•™ï¼ˆä½ è¦çš„é‚£ç§â€œé«˜é€Ÿä¸“çº¿æŽ¨è/è¿è¥å•†/åè®®æç¤ºâ€ï¼‰=====
const TAG_REGEX = keepTags
  ? /(IPLC|IEPL|ä¸“çº¿|é«˜é€Ÿ|æŽ¨è|å®¶å®½|å•†å®½|æ¸¸æˆ|Game|AWS|CF|Cloudflare|ç§»åŠ¨|è”é€š|ç”µä¿¡|BGP|CN2|GIA|CMI|CU|CT|CM|UDP|XUDP|QUIC|HY2|Hysteria2|TUIC|REALITY|GPT|Pro|Std|Exp|Biz|Edge|Kern)/ig
  : null;

// ===== å·¥å…·ï¼šæ¸…ç† =====
function tidy(s) {
  return (s || "")
    .replace(/\s+/g, " ")
    .replace(/\s*\|\s*/g, " | ")
    .trim();
}

// ===== å·¥å…·ï¼šåŽ»æŽ‰åŽŸåé‡Œçš„å›½æ——ï¼ˆé¿å…é‡å¤ï¼‰=====
function stripFlags(s) {
  return (s || "").replace(/[\u{1F1E6}-\u{1F1FF}]{2}/gu, "").trim();
}

// ===== ä»Žå›½æ—— emoji å¾—åˆ° ISO2ï¼ˆRegional Indicatorï¼‰=====
function flagToISO2(flag) {
  // flag æ˜¯ä¸¤ä¸ª regional indicator å­—ç¬¦
  const cps = [...flag].map(ch => ch.codePointAt(0));
  if (cps.length !== 2) return "";
  const A = 0x1F1E6;
  const c1 = cps[0] - A;
  const c2 = cps[1] - A;
  if (c1 < 0 || c1 > 25 || c2 < 0 || c2 > 25) return "";
  return String.fromCharCode(65 + c1) + String.fromCharCode(65 + c2);
}

// ===== æŠ“å€çŽ‡ï¼š0.1å€ / 2Ã— / x2 / Ë£Â² ... =====
function pickRatio(name) {
  if (!keepRatio) return "";
  const n = name || "";
  // Ë£Â² è¿™ç±»
  const sup = n.match(/Ë£[Â²Â³â´âµâ¶â·â¸â¹]|Ë£Â¹â°|Ë£Â²â°|Ë£Â³â°|Ë£â´â°|Ë£âµâ°/);
  if (sup) return sup[0];

  // 0.1å€ / 2å€ / 2x / 2X / 2Ã— / x2
  const m =
    n.match(/(\d+(?:\.\d+)?\s*(?:å€|x|X|Ã—))/) ||
    n.match(/(?:x|X|Ã—)\s*(\d+(?:\.\d+)?)/);
  if (!m) return "";

  const raw = m[0].replace(/\s+/g, "");
  if (/^(x|X|Ã—)\d/.test(raw)) return raw.replace(/^(x|X)/, "") + "Ã—";
  if (/^\d+(\.\d+)?(x|X)$/.test(raw)) return raw.replace(/(x|X)$/, "Ã—");
  return raw;
}

// ===== æŠ“æœ«å°¾åºå·ï¼šåªå–åŽŸåæœ«å°¾ 01/02...ï¼ˆä¸å…¨å±€é‡æŽ’ï¼‰=====
function pickIndex(name) {
  const n = name || "";
  const m = n.match(/(?:\s|-|_)?(\d{2})(?!\d)\s*$/);
  if (m) return m[1];
  const m2 = n.match(/(?:\s|-|_)?(\d)(?!\d)\s*$/);
  if (m2) return "0" + m2[1];
  return "";
}

// ===== æŠ“æ ‡ç­¾ï¼šä¿ç•™åŽŸåé‡Œå‡ºçŽ°çš„å…³é”®è¯ï¼ŒåŽ»é‡ä¿æŒé¡ºåº =====
function pickTags(name) {
  if (!TAG_REGEX) return "";
  const ms = (name || "").match(TAG_REGEX);
  if (!ms || !ms.length) return "";
  const out = [];
  for (const t of ms) {
    const k = t.toUpperCase();
    if (!out.map(x => x.toUpperCase()).includes(k)) out.push(t);
  }
  return out.join("");
}

// ===== è¯†åˆ«å›½å®¶ï¼šå›½æ—— > ISO2 > è‹±æ–‡å›½å®¶å > ä¸­æ–‡å›½å®¶å/å…³é”®è¯ =====
function detectCountry(rawName) {
  const raw = rawName || "";

  // 1) å›½æ——ä¼˜å…ˆï¼ˆè‡ªåŠ¨é€‚é…æ–°å›½å®¶ï¼‰
  const flagMatch = raw.match(/[\u{1F1E6}-\u{1F1FF}]{2}/u);
  if (flagMatch) {
    const flag = flagMatch[0];
    const iso2 = flagToISO2(flag);
    const zh = ISO2_ZH[iso2] || iso2; // ä¸åœ¨è¡¨é‡Œå°±ç”¨ ISO2 æ˜¾ç¤º
    return { iso2, zh, flag };
  }

  // 2) ISO2ï¼šç”¨å•è¯è¾¹ç•Œé¿å…è¯¯ä¼¤ï¼ˆæ¯”å¦‚ â€œusâ€ å‡ºçŽ°åœ¨ â€œasusâ€ é‡Œï¼‰
  const iso2Match = raw.match(/\b([A-Z]{2})\b/);
  if (iso2Match) {
    const iso2 = iso2Match[1].toUpperCase();
    if (ISO2_ZH[iso2] || iso2.length === 2) {
      const zh = ISO2_ZH[iso2] || iso2;
      const flag = iso2ToFlag(iso2);
      return { iso2, zh, flag };
    }
  }

  // 3) è‹±æ–‡å›½å®¶å
  for (const [re, iso2] of ENNAME_ISO2) {
    if (re.test(raw)) {
      const zh = ISO2_ZH[iso2] || iso2;
      const flag = iso2ToFlag(iso2);
      return { iso2, zh, flag };
    }
  }

  // 4) ä¸­æ–‡å›½å®¶åå…³é”®è¯ï¼ˆå¸¸ç”¨ï¼‰
  const cn = [
    [/é¦™æ¸¯/, "HK"], [/æ¾³é—¨/, "MO"], [/å°æ¹¾|å°åŒ—|æ–°åŒ—|é«˜é›„|å°ä¸­/, "TW"],
    [/æ—¥æœ¬|ä¸œäº¬|å¤§é˜ª|åå¤å±‹|æœ­å¹Œ|ç¦å†ˆ/, "JP"],
    [/æ–°åŠ å¡|ç‹®åŸŽ/, "SG"],
    [/ç¾Žå›½|æ´›æ‰çŸ¶|åœ£ä½•å¡ž|çº½çº¦|è¥¿é›…å›¾|èŠåŠ å“¥|ç¡…è°·/, "US"],
    [/éŸ©å›½|é¦–å°”|é‡œå±±|ä»å·|æ˜¥å·/, "KR"],
    [/è‹±å›½|ä¼¦æ•¦/, "GB"],
    [/å¾·å›½|æ³•å…°å…‹ç¦/, "DE"],
    [/æ³•å›½|å·´é»Ž/, "FR"],
    [/æ¾³å¤§åˆ©äºš|æ‚‰å°¼|å¢¨å°”æœ¬/, "AU"],
    [/è¿ªæ‹œ|é˜¿è”é…‹/, "AE"],
    [/åœŸè€³å…¶|ä¼Šæ–¯å¦å¸ƒå°”/, "TR"],
    [/å°åº¦|å­Ÿä¹°|å¾·é‡Œ/, "IN"],
    [/ä¿„ç½—æ–¯|èŽ«æ–¯ç§‘/, "RU"],
  ];
  for (const [re, iso2] of cn) {
    if (re.test(raw)) {
      const zh = ISO2_ZH[iso2] || iso2;
      const flag = iso2ToFlag(iso2);
      return { iso2, zh, flag };
    }
  }

  return null;
}

// ===== ISO2 -> å›½æ—— emoji =====
function iso2ToFlag(iso2) {
  if (!/^[A-Z]{2}$/.test(iso2)) return "";
  const A = 0x1F1E6;
  const c1 = iso2.charCodeAt(0) - 65;
  const c2 = iso2.charCodeAt(1) - 65;
  if (c1 < 0 || c1 > 25 || c2 < 0 || c2 > 25) return "";
  return String.fromCodePoint(A + c1) + String.fromCodePoint(A + c2);
}

// ===== ä»ŽåŽŸåé‡ŒæŠ“â€œåŸŽå¸‚å…³é”®è¯â€ï¼ˆè®©ä½ çœ‹åˆ° æ—¥æœ¬ä¸œäº¬ / ç¾Žå›½æ´›æ‰çŸ¶ è¿™ç§ï¼‰=====
function pickCity(raw) {
  const s = raw || "";
  for (const k of CITY_KEYWORDS) {
    const re = new RegExp(k.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"), "i");
    if (re.test(s)) return k;
  }
  return "";
}

// ===== æž„é€ æœ€ç»ˆåå­— =====
function buildName(oldName) {
  const raw0 = tidy(oldName);
  if (!raw0) return raw0;

  // å…ˆåŽ»æŽ‰åŽŸåå›½æ——ï¼Œé¿å…é‡å¤å åŠ 
  const rawNoFlag = tidy(stripFlags(raw0));

  const info = detectCountry(raw0); // æ³¨æ„ï¼šç”¨åŽŸå§‹ raw0ï¼ˆå¯èƒ½å«å›½æ——/ISO2/è‹±æ–‡ï¼‰
  const idx = pickIndex(rawNoFlag);
  const ratio = pickRatio(rawNoFlag);
  const tags = pickTags(rawNoFlag);

  // æè¿°ï¼šå°½é‡ä¿ç•™â€œé«˜é€Ÿä¸“çº¿æŽ¨è/è¿è¥å•†â€ç­‰ï¼ŒæŠŠå›½å®¶/åŸŽå¸‚/å€çŽ‡/æœ«å°¾åºå·æ¸…æŽ‰
  let desc = rawNoFlag;

  // åŽ»å€çŽ‡
  if (ratio) {
    const r = ratio.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    desc = desc.replace(new RegExp(r, "g"), "");
  }
  // åŽ»æœ«å°¾åºå·
  if (idx) {
    desc = desc.replace(new RegExp(`(?:\\s|-|_)?${idx}(?!\\d)\\s*$`), "");
  }
  // åŽ»å›½å®¶ç›¸å…³è¯ï¼ˆè½»é‡ï¼‰
  if (info) {
    if (info.zh && info.zh !== info.iso2) {
      desc = desc.replace(new RegExp(info.zh, "g"), "");
    }
    if (info.iso2) {
      desc = desc.replace(new RegExp(`\\b${info.iso2}\\b`, "g"), "");
    }
  }

  // åŽ»å¸¸è§åˆ†éš”æ®‹ç•™
  desc = tidy(desc).replace(/^\||\|$/g, "").trim();

  // å¦‚æžœ desc ä¸ºç©ºï¼Œç”¨ tags å…œåº•ï¼›å†ä¸è¡Œç”¨åŽŸåå…œåº•
  if (!desc && tags) desc = tags;
  if (!desc) desc = rawNoFlag;

  // ç»„è£…å·¦ä¾§ï¼šðŸ‡ºðŸ‡¸ç¾Žå›½æ´›æ‰çŸ¶01-0.1å€
  if (!info) {
    // æœªåŒ¹é…ï¼šæŒ‰ nm å†³å®š
    return nm ? (FNAME ? `${FNAME} ${rawNoFlag}` : rawNoFlag) : null;
  }

  const city = pickCity(raw0);
  const region = `${info.zh}${city && !String(city).includes(info.zh) ? city : ""}`;

  const flag = addflag ? info.flag : "";
  const ratioPart = ratio ? `-${ratio}` : "";
  const left = `${flag}${region}${idx ? idx : ""}${ratioPart}`;

  let finalName = `${left}${SEP}${desc}`;

  // å‰ç¼€ name=
  if (FNAME) {
    finalName = nf ? `${FNAME} ${finalName}` : `${FNAME} ${finalName}`;
  }

  return tidy(finalName);
}

// ===== Clash éœ€è¦ name å”¯ä¸€ï¼šé‡å¤åˆ™åŠ  #2 #3... =====
function ensureUnique(list) {
  const seen = new Map();
  for (const p of list) {
    const n = p.name;
    const c = seen.get(n) || 0;
    if (c === 0) {
      seen.set(n, 1);
    } else {
      seen.set(n, c + 1);
      p.name = `${n}#${c + 1}`;
    }
  }
  return list;
}

// ===== Sub-Store å…¥å£ =====
function operator(proxies) {
  if (!Array.isArray(proxies)) return proxies;

  for (const p of proxies) {
    if (!p || !p.name) continue;

    const newName = buildName(p.name);
    if (newName === null) {
      // nm=false ä¸”æœªåŒ¹é…ï¼šä¸¢å¼ƒ
      p.name = null;
      continue;
    }
    p.name = newName;

    // âœ… ç»å¯¹ä¸æ”¹åŠ¨ p çš„å…¶å®ƒå­—æ®µï¼ˆtype / udp / network / flow / reality / sni...ï¼‰
    // è¿™æ ·å®¢æˆ·ç«¯æ‰èƒ½è‡ªåŠ¨æ˜¾ç¤ºä½ æˆªå›¾é‚£ç§ â€œvless / xudpâ€ã€â€œhy2 / udpâ€
  }

  const out = proxies.filter(p => p && p.name);
  return ensureUnique(out);
}
